/* Teleprompter (c) 2015 by David Schwarz */

var teleprompter=angular.module("teleprompter",["ui.router","ui.router.stateHelper"]);teleprompter.config(["stateHelperProvider","$urlRouterProvider",function(a,b){a.state({name:"root",url:"/",views:{main:{templateUrl:"/page/index.html",controller:"mainCtrl"}}}).state({name:"host",url:"/host",views:{main:{templateUrl:"/page/host.html",controller:"hostCtrl"}}}).state({name:"client",url:"/client",views:{main:{templateUrl:"/page/client.html",controller:"clientCtrl"}}}).state({name:"play",views:{main:{templateUrl:"/page/play.html",controller:"playCtrl"}}}).state({name:"err404",url:"/err404",views:{main:{templateUrl:"/page/404.html"}}}),b.when("","/"),b.otherwise("/err404")}]),teleprompter.run(["$state","socket",function(a,b){a.is("root")||(b.emit("isConnected"),b.on("isConntected",function(b){b||a.go("root")})),b.on("disconnect",function(){console.log("disconnected"),a.go("root")})}]),teleprompter.controller("clientCtrl",["$scope","$rootScope","$http","$window","$state","socket",function(a,b,c,d,e,f){function g(){f.emit("setResolution",{x:d.innerWidth,y:d.innerHeight})}g(),angular.element(d).on("resize",g),a.resolution={transform:"rotateY(180deg)"},f.on("kick",function(){e.go("root")})}]),teleprompter.controller("hostCtrl",["$scope","$rootScope","$state","$http","socket",function(a,b,c,d,e){a.roomId="n/a",a.resolution={width:"100vw",height:"100vh"},e.emit("host"),e.on("host",function(b){a.$apply(function(){a.roomId=b[0]})}),b.$watch("text",function(){e.emit("setText",b.text?b.text.replace(/\r?\n/g,"<br>"):null)}),e.emit("updateClients"),e.on("client",function(b){a.$apply(function(){a.clients=b[0]})}),a.play=function(a,b){a.preventDefault(),e.emit("play",b),c.go("play")}}]),teleprompter.controller("mainCtrl",["$scope","$state","$window","socket",function(a,b,c,d){d.emit("disconnect",!0),a.$watch("roomId",function(){d.emit("join",{rid:a.roomId,resolution:{x:c.innerWidth,y:c.innerHeight}})}),d.on("join",function(a){b.go("client")})}]),teleprompter.controller("playCtrl",["$scope","$state","$timeout","$window","socket",function(a,b,c,d,e){e.on("kick",function(){b.go("host")}),e.emit("t_getSize"),e.on("t_setSize",function(b){a.$apply(function(){var c=d.innerWidth/b[0].x*.95;d.innerHeight>d.innerWidth&&(c=d.innerHeight/b[0].y*.95),a.resolution={width:b[0].x,height:b[0].y,transform:"scale("+c+")"}})})}]),teleprompter.directive("teleprompter",["$sce","socket",function(a,b){return{restrict:"AE",templateUrl:"/page/teleprompter.html",replace:!1,link:function(c,d,e){b.emit("t_getText"),b.on("t_getText",function(b){c.$apply(function(){console.log(b),c.teleText=a.trustAsHtml(b[0])})}),b.on("t_setMargin",function(a){angular.element(d).find("p").css("margin-top",a[0]+"px")}),b.on("t_font",function(a){angular.element(d).find("p").css("font-size",a[0]+"em")})}}}]),teleprompter.directive("trigger",["socket",function(a){return{restrict:"A",link:function(b,c,d){angular.element(c).click(function(b){b.preventDefault(),"BUTTON"===b.target.tagName&&(console.log("click"),a.emit(d.trigger))}),angular.element(c).change(function(b){b.preventDefault(),console.log(c.val()),a.emit(d.trigger,c.val())})}}}]),teleprompter.factory("socket",[function(){var a=io.connect();return{on:function(b,c){a.on(b,function(){var a=arguments;c(a)})},emit:function(b,c,d){a.emit(b,c),d&&d.apply(a)}}}]);